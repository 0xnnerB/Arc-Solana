<script>
/* =========================================================
   FLUXSHIFT — Circle Bridge Kit (UI 1:1 COMPATIBLE)
   ========================================================= */

/* ===== CONFIG ===== */
const CIRCLE_API_KEY = 'SUA_API_KEY_DA_CIRCLE';
const CIRCLE_API = 'https://api.circle.com/v1';

const CONFIG = {
  NETWORKS: {
    arc: 'arc',
    sepolia: 'ethereum-sepolia',
    solana: 'solana',
    base: 'base'
  }
};

const headers = {
  'Authorization': `Bearer ${CIRCLE_API_KEY}`,
  'Content-Type': 'application/json'
};

/* ===== UI HELPERS (INALTERADOS) ===== */
const $ = id => document.getElementById(id);

function setProgress(percent, message) {
  $('progressBar').style.width = percent + '%';
  $('progressPercent').textContent = Math.round(percent) + '%';
  $('progressMessage').textContent = message;
}

function updateStepStatus(stepId, status) {
  const step = $(stepId);
  const circle = step.querySelector('div');
  const text = step.querySelector('span');
  const statusSpan = $(stepId + 'status');

  step.classList.remove(
    'border-gray-600','border-yellow-500','border-green-500','border-red-500',
    'bg-slate-800/30','bg-yellow-500/10','bg-green-500/10','bg-red-500/10'
  );
  circle.classList.remove('bg-gray-600','bg-yellow-500','bg-green-500','bg-red-500');
  text.classList.remove('text-gray-400','text-yellow-300','text-green-300','text-red-300');
  statusSpan.className = 'text-xs';

  if (status === 'completed') {
    step.classList.add('border-green-500','bg-green-500/10');
    circle.classList.add('bg-green-500'); circle.innerHTML = '✓';
    text.classList.add('text-green-300');
    statusSpan.textContent='✓'; statusSpan.classList.add('text-green-400');
  } else if (status === 'pending') {
    step.classList.add('border-yellow-500','bg-yellow-500/10');
    circle.classList.add('bg-yellow-500');
    text.classList.add('text-yellow-300');
    statusSpan.textContent='⏳'; statusSpan.classList.add('text-yellow-400');
  } else if (status === 'error') {
    step.classList.add('border-red-500','bg-red-500/10');
    circle.classList.add('bg-red-500');
    text.classList.add('text-red-300');
    statusSpan.textContent='✗'; statusSpan.classList.add('text-red-400');
  } else {
    step.classList.add('border-gray-600','bg-slate-800/30');
    circle.classList.add('bg-gray-600'); circle.innerHTML = stepId.replace('step','');
    text.classList.add('text-gray-400');
    statusSpan.textContent='';
  }
}

/* ===== STATE ===== */
let userAddress = null;
let bridgeDirection = 'arc-to-sepolia';
let currentPendingTx = null;

/* ===== WALLET (INALTERADO) ===== */
async function connectWallet() {
  const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
  userAddress = accounts[0];
  $('walletShort').textContent = userAddress.slice(0,6)+'.'+userAddress.slice(-4);
  $('walletIndicator').classList.remove('hidden');
  $('headerConnectBtn').classList.add('hidden');
  $('bridgeForm').classList.remove('hidden');
}

/* =========================================================
   CIRCLE BRIDGE KIT — ABSTRAÇÃO
   ========================================================= */

async function createBridgeTransfer(from, to, amount, recipient) {
  const res = await fetch(`${CIRCLE_API}/bridge/transfers`, {
    method: 'POST',
    headers,
    body: JSON.stringify({
      source_chain: from,
      destination_chain: to,
      amount,
      token: 'USDC',
      destination_address: recipient
    })
  });
  if (!res.ok) throw new Error(await res.text());
  return res.json();
}

async function getBridgeStatus(id) {
  const res = await fetch(`${CIRCLE_API}/bridge/transfers/${id}`, { headers });
  if (!res.ok) throw new Error(await res.text());
  return res.json();
}

/* =========================================================
   BRIDGE FLOW (UI PRESERVADA)
   ========================================================= */

async function executeBridge() {
  resetProgressUI();

  const rawAmount = $('bridgeAmount').value;
  if (!rawAmount || Number(rawAmount) <= 0) {
    alert('Please enter a valid amount!');
    return;
  }

  const recipient = userAddress;

  $('bridgeForm').classList.add('hidden');
  $('bridgeProgress').classList.remove('hidden');
  $('mintReadySection').classList.add('hidden');
  $('estimatedTime').classList.add('hidden');

  setProgress(5, 'Starting bridge.');
  updateStepStatus('step1','completed');
  updateStepStatus('step2','pending');

  try {
    const [fromKey, toKey] = bridgeDirection.split('-to-');

    const transfer = await createBridgeTransfer(
      CONFIG.NETWORKS[fromKey],
      CONFIG.NETWORKS[toKey],
      rawAmount,
      recipient
    );

    currentPendingTx = {
      bridgeId: transfer.id,
      status: 'pending',
      sender: userAddress
    };

    updateStepStatus('step2','completed');
    updateStepStatus('step3','pending');
    setProgress(45, 'Bridge in progress.');

    waitForAttestation(transfer.id);

  } catch (e) {
    console.error(e);
    $('errorMessage').classList.remove('hidden');
    $('errorDetail').textContent = e.message;
    setProgress(0,'Error');
  }
}

/* ===== REIMPLEMENTAÇÃO COMPATÍVEL ===== */
async function waitForAttestation(bridgeId) {
  const interval = setInterval(async () => {
    try {
      const tx = await getBridgeStatus(bridgeId);

      const map = {
        pending: 55,
        processing: 65,
        bridging: 80,
        completed: 100
      };

      setProgress(map[tx.status] || 60, `Status: ${tx.status}`);

      if (tx.status === 'completed') {
        clearInterval(interval);
        updateStepStatus('step3','completed');
        updateStepStatus('step4','completed');
        $('successMessage').classList.remove('hidden');
        setTimeout(resetBridge, 4000);
      }

      if (tx.status === 'failed') {
        clearInterval(interval);
        throw new Error(tx.error || 'Bridge failed');
      }

    } catch (e) {
      clearInterval(interval);
      updateStepStatus('step3','error');
      $('errorMessage').classList.remove('hidden');
      $('errorDetail').textContent = e.message;
    }
  }, 5000);
}

/* ===== NO-OPs PARA COMPATIBILIDADE UI ===== */
async function executeManualMint() {
  alert('This bridge completes automatically.');
}

/* ===== UI ===== */
function swapNetworks() {
  bridgeDirection = bridgeDirection === 'arc-to-sepolia'
    ? 'sepolia-to-arc'
    : 'arc-to-sepolia';
  updateNetworkUI();
}

function updateNetworkUI() {
  $('directionText').textContent =
    bridgeDirection === 'arc-to-sepolia'
      ? 'Arc Testnet → Sepolia'
      : 'Sepolia → Arc Testnet';
}

function resetProgressUI() {
  setProgress(0,'Preparing.');
  ['step1','step2','step3','step4'].forEach(s=>updateStepStatus(s,'idle'));
}

/* ===== EVENTS ===== */
$('connectWalletBtn').addEventListener('click', connectWallet);
$('startBridgeBtn').addEventListener('click', executeBridge);
$('swapNetworksBtn').addEventListener('click', swapNetworks);

/* INIT */
resetProgressUI();
updateNetworkUI();
</script>
